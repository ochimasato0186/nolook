"use client";

import { useState, useEffect, useRef } from "react";
import "../../../styles/student-responsive.css";
import SmartphoneHeader from "../../../components/frame/SmartphoneHeader";
import StudentBell from "../../../components/student/StudentBell";
import StudentFooter from "../../../components/student/StudentFooter";
import Scene from "../../../components/3D/Scene";
import { useNews } from "../../../hooks/useNews";
import { emotionService } from "../../../lib/api";
import { getCurrentUser } from "../../../lib/userManager";
import {
  FaUser,
  FaHeart,
  FaStar,
  FaCoffee,
  FaCat,
  FaDog,
  FaGamepad,
  FaMusic,
  FaPalette,
} from "react-icons/fa";
import { FaRegCircleUser } from "react-icons/fa6";
import { MdFace } from "react-icons/md";

// „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂûãÂÆöÁæ©
interface ChatMessage {
  id: string;
  type: "user" | "ai";
  content: string;
  emotion?: string;
  timestamp: Date;
  ai_used?: boolean;
}

export default function ChatPage() {
  // Service WorkerÁôªÈå≤ÔºÜÈÄöÁü•Ë®±ÂèØ
  useEffect(() => {
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js").then(() => {
        console.log("Service Worker registered");
      });
    }
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }
  }, []);

  const [message, setMessage] = useState(""); // ÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„ÉàÁÆ°ÁêÜ
  const [chatHistory, setChatHistory] = useState<ChatMessage[]>([]); // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÁÆ°ÁêÜ
  const [isLoading, setIsLoading] = useState(false); // ÈÄÅ‰ø°‰∏≠„Éï„É©„Ç∞
  const [error, setError] = useState<string | null>(null); // „Ç®„É©„ÉºÁÆ°ÁêÜ
  const [jsonData, setJsonData] = useState<any>(null); // ÂèñÂæó„Åó„ÅüJSON„Éá„Éº„Çø
  const [chatAreaBackground, setChatAreaBackground] = useState<string>("white"); // „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ËÉåÊôØ
  const [chatBackgroundImage, setChatBackgroundImage] = useState<string | null>(
    null
  ); // „ÉÅ„É£„ÉÉ„ÉàËÉåÊôØÁîªÂÉè
  const { newNewsCount } = useNews(); // „Éã„É•„Éº„Çπ„Ç´„Ç¶„É≥„Éà„ÇíÂèñÂæó
  const chatContainerRef = useRef<HTMLDivElement>(null); // „ÉÅ„É£„ÉÉ„Éà„Ç≥„É≥„ÉÜ„Éä„ÅÆÂèÇÁÖß
  const [userIcon, setUserIcon] = useState<string | null>(null);
  const [userUploadedImage, setUserUploadedImage] = useState<string | null>(
    null
  );
  const [aiIconUrl, setAiIconUrl] = useState<string>("/icons/crione.svg");

  // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÊúÄÂ§ßÊï∞„ÇíÂà∂ÈôêÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏ä„ÅÆ„Åü„ÇÅÔºâ
  const MAX_CHAT_HISTORY = 50;

  // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Éû„Ç¶„É≥„ÉàÊôÇ„Å´„ÉÅ„É£„ÉÉ„ÉàËÉåÊôØË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
  useEffect(() => {
    const savedChatAreaBackground = localStorage.getItem("chatAreaBackground");
    const savedChatBackgroundImage = localStorage.getItem("chatBackgroundImage");
    if (savedChatAreaBackground) {
      setChatAreaBackground(savedChatAreaBackground);
    }
    if (savedChatBackgroundImage) {
      setChatBackgroundImage(savedChatBackgroundImage);
    }
    // prefer icon from currentUser profile if available
    try {
      const curr = getCurrentUser();
      if (curr) {
        // possible fields where apps store avatars/icons
        const maybe =
          (curr as any).uploadedImage ||
          (curr as any).avatar ||
          (curr as any).icon ||
          (curr as any).photoUrl ||
          (curr as any).userIcon;
        if (maybe && typeof maybe === "string") {
          // treat absolute/relative urls as uploaded image
          if (/^https?:\/\//i.test(maybe) || maybe.startsWith("/")) {
            setUserUploadedImage(maybe);
          } else {
            setUserIcon(maybe);
          }
        }
      }
    } catch (e) {
      // ignore
    }
    // load user icon preferences
    const loadUserIcons = () => {
      try {
        const ui = localStorage.getItem("userIcon");
        const uimg = localStorage.getItem("userUploadedImage");
        if (ui) setUserIcon(ui);
        if (uimg) setUserUploadedImage(uimg);
      } catch (e) {
        // ignore in environments without localStorage
      }
    };
    loadUserIcons();
    // load aiIcon initial value
    try {
      const v = localStorage.getItem("aiIcon");
      if (v) setAiIconUrl(v);
    } catch (e) {}

    // live-sync: when settings change in another tab or modal, update icons
    const onStorage = (e: StorageEvent) => {
      if (!e.key) return;
      if (e.key === "userIcon" || e.key === "userUploadedImage") {
        loadUserIcons();
      }
      if (e.key === "aiIcon") {
        const v = localStorage.getItem("aiIcon");
        if (v) setAiIconUrl(v);
      }
      if (
        e.key === "chatAreaBackground" ||
        e.key === "chatBackgroundImage"
      ) {
        const savedChatAreaBackground =
          localStorage.getItem("chatAreaBackground");
        const savedChatBackgroundImage =
          localStorage.getItem("chatBackgroundImage");
        if (savedChatAreaBackground)
          setChatAreaBackground(savedChatAreaBackground);
        if (savedChatBackgroundImage)
          setChatBackgroundImage(savedChatBackgroundImage);
      }
    };
    window.addEventListener("storage", onStorage);
    // also reload when window gains focus (user may have changed settings in modal)
    const onFocus = () => {
      loadUserIcons();
      try {
        const v = localStorage.getItem("aiIcon");
        if (v) setAiIconUrl(v);
      } catch (e) {}
    };
    window.addEventListener("focus", onFocus);

    // cleanup
    return () => {
      window.removeEventListener("storage", onStorage);
      window.removeEventListener("focus", onFocus);
    };
  }, []);

  // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅåËøΩÂä†„Åï„Çå„Åü„Å®„Åç„Å´Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
  useEffect(() => {
    if (chatContainerRef.current) {
      const container = chatContainerRef.current;
      // „Çπ„É†„Éº„Ç∫„Çπ„ÇØ„É≠„Éº„É´„ÅßÊúÄ‰∏ãÈÉ®„Å´ÁßªÂãï
      container.scrollTo({
        top: container.scrollHeight,
        behavior: "smooth",
      });
    }
  }, [chatHistory, isLoading]);

  // „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ËÉåÊôØ„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
  const getChatAreaBackgroundStyle = () => {
    const backgroundMap: Record<string, string> = {
      white: "#f5f5f5",
      light_blue: "#e6f3ff",
      light_green: "#e6ffe6",
      light_pink: "#ffe6f0",
      light_purple: "#f0e6ff",
      cream: "#fff5d6",
      mint: "#e6fff5",
      light_gray: "#f0f0f0",
    };
    return backgroundMap[chatAreaBackground] || "#f5f5f5";
  };

  // „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
  const getChatAreaStyle = () => {
    if (chatAreaBackground === "custom" && chatBackgroundImage) {
      return {
        background: `url(${chatBackgroundImage})`,
        backgroundSize: "cover",
        backgroundPosition: "center",
        backgroundRepeat: "no-repeat",
      };
    }
    return {
      background: getChatAreaBackgroundStyle(),
    };
  };

  // AI „Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åô„ÇãÈñ¢Êï∞
  const handleSend = async () => {
    if (!message.trim() || isLoading) return; // Á©∫„Åæ„Åü„ÅØ„É≠„Éº„Éá„Ç£„É≥„Ç∞‰∏≠„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

    setError(null);
    setIsLoading(true);

    // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ±•Ê≠¥„Å´ËøΩÂä†
    const userMessage: ChatMessage = {
      id: Date.now().toString(),
      type: "user",
      content: message.trim(),
      timestamp: new Date(),
    };

    setChatHistory((prev) => {
      const newHistory = [...prev, userMessage];
      // Â±•Ê≠¥„ÅåÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÄÅÂè§„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
      return newHistory.length > MAX_CHAT_HISTORY
        ? newHistory.slice(-MAX_CHAT_HISTORY)
        : newHistory;
    });
    const currentMessage = message;
    setMessage(""); // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢

    // AI‰ºöË©±Ë®òÈå≤„Çí‰øùÂ≠òÔºà‰ªäÊó•„ÅÆÊó•‰ªòÔºâ
    const today = new Date();
    const dateKey = `${today.getFullYear()}-${
      today.getMonth() + 1
    }-${today.getDate()}`;
    const aiConversationDates = JSON.parse(
      localStorage.getItem("aiConversationDates") || "{}"
    );
    aiConversationDates[dateKey] = {
      date: dateKey,
      lastConversation: today.toISOString(),
      messageCount: (aiConversationDates[dateKey]?.messageCount || 0) + 1,
    };
    localStorage.setItem("aiConversationDates", JSON.stringify(aiConversationDates));

    try {
      // ÊÑüÊÉÖ„Å´Âü∫„Å•„ÅÑ„Å¶„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„Éó„ÅÆÂøÖË¶ÅÊÄß„ÇíÂà§ÂÆö
      const needsFollowup =
        currentMessage.toLowerCase().includes("‰∏çÂÆâ") ||
        currentMessage.toLowerCase().includes("„Åó„Çì„Å©„ÅÑ") ||
        currentMessage.toLowerCase().includes("Ëæõ„ÅÑ") ||
        currentMessage.toLowerCase().includes("ÂøÉÈÖç");

      // „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâAPI„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°Ôºàask.py„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩøÁî®Ôºâ
      const response = await emotionService.ask({
        prompt: currentMessage,
        style: "buddy",
        followup: needsFollowup, // ÂøÖË¶Å„Å™Â†¥Âêà„ÅÆ„Åø„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„Éó„ÇíÊúâÂäπÂåñ
      });

      // AI „ÅÆËøî‰ø°„ÇíÂ±•Ê≠¥„Å´ËøΩÂä†
      const aiMessage: ChatMessage = {
        id: (Date.now() + 1).toString(),
        type: "ai",
        content: response.reply,
        emotion: response.emotion,
        timestamp: new Date(),
        ai_used: response.used_llm,
      };

      setChatHistory((prev) => {
        const newHistory = [...prev, aiMessage];
        // Â±•Ê≠¥„ÅåÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÄÅÂè§„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
        return newHistory.length > MAX_CHAT_HISTORY
          ? newHistory.slice(-MAX_CHAT_HISTORY)
          : newHistory;
      });

      // AIÂøúÁ≠îÊôÇ„Å´„ÇÇ‰ºöË©±Ë®òÈå≤„ÇíÊõ¥Êñ∞
      const updatedAiConversationDates = JSON.parse(
        localStorage.getItem("aiConversationDates") || "{}"
      );
      if (updatedAiConversationDates[dateKey]) {
        updatedAiConversationDates[dateKey].lastConversation =
          new Date().toISOString();
        updatedAiConversationDates[dateKey].messageCount += 1;
        localStorage.setItem(
          "aiConversationDates",
          JSON.stringify(updatedAiConversationDates)
        );
      }

      // JSON„Éá„Éº„Çø„ÇíÂèñÂæóÔºà„Éá„É¢Áî®„ÅÆÂ≠¶ÁîüID "demo-student" „Çí‰ΩøÁî®Ôºâ
      try {
        const latestResponse =
          await emotionService.getLatestAiResponse("demo-student");
        if (latestResponse) {
          setJsonData(latestResponse);
          console.log("Latest AI response JSON:", latestResponse);
        }
      } catch (jsonErr) {
        console.warn("Failed to get JSON data:", jsonErr);
      }
    } catch (err) {
      console.error("üö® Message send error:", err);

      let errorMessageText = "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";
      if (err instanceof Error) {
        if (err.name === "AbortError") {
          errorMessageText =
            "„É™„ÇØ„Ç®„Çπ„Éà„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        } else if (err.message.includes("fetch")) {
          errorMessageText =
            "„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        } else {
          errorMessageText = `„Ç®„É©„Éº: ${err.message}`;
        }
      }

      setError(errorMessageText);

      // „Ç®„É©„ÉºÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î
      const errorMessage: ChatMessage = {
        id: (Date.now() + 1).toString(),
        type: "ai",
        content:
          "„Åô„Åø„Åæ„Åõ„Çì„ÄÅÁèæÂú®Ëøî‰ø°„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Åó„Å∞„Çâ„ÅèÁµå„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
        timestamp: new Date(),
      };
      setChatHistory((prev) => {
        const newHistory = [...prev, errorMessage];
        // Â±•Ê≠¥„ÅåÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„ÅüÂ†¥Âêà„ÄÅÂè§„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
        return newHistory.length > MAX_CHAT_HISTORY
          ? newHistory.slice(-MAX_CHAT_HISTORY)
          : newHistory;
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <>
      {/* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */}
      <style jsx>{`
        @keyframes bounce {
          0%,
          80%,
          100% {
            transform: scale(0.8);
            opacity: 0.5;
          }
          40% {
            transform: scale(1);
            opacity: 1;
          }
        }

        :global(.custom-scrollbar) {
          scrollbar-width: thin;
          scrollbar-color: #ccc #f1f1f1;
        }

        :global(.custom-scrollbar::-webkit-scrollbar) {
          width: 6px;
        }

        :global(.custom-scrollbar::-webkit-scrollbar-track) {
          background: #f1f1f1;
          border-radius: 3px;
        }

        :global(.custom-scrollbar::-webkit-scrollbar-thumb) {
          background: #ccc;
          border-radius: 3px;
        }

        :global(.custom-scrollbar::-webkit-scrollbar-thumb:hover) {
          background: #999;
        }

        /* „Çπ„Éû„ÉõÊû†„ÅÆ‰∏≠Ë∫´„Çí100%„ÅßÂüã„ÇÅ„Çã„Ç≥„É≥„ÉÜ„Éä */
        .student-chat-root {
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          position: relative;
          background: #001f3f;
        }

        .chat-main {
          display: flex;
          flex-direction: column;
          height: 100%;
          padding: 8px 10px 76px;
          box-sizing: border-box;
        }

        .clione-area {
          flex: 0 0 90px;
          display: flex;
          justify-content: center;
          align-items: flex-end;
          margin-bottom: 8px;
        }

        .clione-box {
          width: 120px;
          height: 120px;
          position: relative;
          overflow: hidden;
        }

        .chat-area-wrap {
          flex: 1;
          display: flex;
          flex-direction: column;
          min-height: 0;
        }

        .input-area {
          flex: 0 0 auto;
          margin-top: 8px;
        }
      `}</style>

      {/* StudentLayout provides the outer smartphone frame. Render only the inner screen here. */}
      <div className="student-chat-root">
          <SmartphoneHeader />
          <div
            style={{ position: "absolute", top: "25mm", right: "3mm", zIndex: 50 }}
          >
            <StudentBell count={newNewsCount} color="#fff" />
          </div>

          <main className="chat-main">
            <div style={{ height: "8px", flexShrink: 0 }}></div>

            {/* „ÇØ„É™„Ç™„ÉçÁî®„Ç®„É™„Ç¢ - Âõ∫ÂÆö„Çµ„Ç§„Ç∫„Åß „Çπ„ÇØ„É≠„Éº„É´ÊôÇ„ÅÆÂ§âÂΩ¢„ÇíÈò≤„Åê */}
            <div
              style={{
                width: "100%",
                display: "flex",
                justifyContent: "center",
                marginTop: 16,
                flexShrink: 0,
              }}
            >
              <div style={{ width: 120, height: 120, position: "relative", overflow: "hidden" }}>
                <Scene />
              </div>
            </div>

            {/* „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ */}
            <div
              style={{
                display: "flex",
                flexDirection: "column",
                padding: "0 10px",
                margin: "8px 0",
                minHeight: 0,
                height: 240,
                flexShrink: 0,
                overflow: "hidden",
              }}
            >
              {/* „Ç®„É©„ÉºË°®Á§∫ */}
              {error && (
                <div
                  style={{
                    background: "#fee",
                    border: "1px solid #fcc",
                    borderRadius: "4px",
                    padding: "6px",
                    marginBottom: "8px",
                    fontSize: "12px",
                    color: "#c33",
                    flexShrink: 0, // „Ç®„É©„ÉºË°®Á§∫„ÅØÁ∏ÆÂ∞è„Åó„Å™„ÅÑ
                  }}
                >
                  {error}
                </div>
              )}

              <div
                ref={chatContainerRef}
                style={{
                  flex: 1, // Ë¶™„ÅÆÊÆã„ÇäÁ©∫Èñì„Çí‰ΩøÁî®
                  ...getChatAreaStyle(), // ÂãïÁöÑ„Å™ËÉåÊôØ„ÇíÈÅ©Áî®
                  borderRadius: "8px",
                  border: "1px solid #ccc",
                  padding: "8px",
                  overflowY: "auto", // Á∏¶„Çπ„ÇØ„É≠„Éº„É´„ÇíÊúâÂäπ
                  fontSize: "14px",
                  marginBottom: "8px",
                  display: "flex",
                  flexDirection: "column",
                  minHeight: 0, // ÈáçË¶Å: „Éï„É¨„ÉÉ„ÇØ„Çπ„Ç¢„Ç§„ÉÜ„É†„ÅÆÁ∏ÆÂ∞è„ÇíË®±ÂèØ
                  scrollBehavior: "smooth", // „Çπ„É†„Éº„Ç∫„Çπ„ÇØ„É≠„Éº„É´
                  // „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÔºàWebkitÁ≥ª„Éñ„É©„Ç¶„Ç∂Áî®Ôºâ
                  WebkitOverflowScrolling: "touch",
                }}
                className="custom-scrollbar"
              >
                {chatHistory.length === 0 ? null : (
                  <>
                    {chatHistory.map((msg) => (
                      <div
                        key={msg.id}
                        style={{
                          marginBottom: "10px",
                          display: "flex",
                          flexDirection: "column",
                          alignItems:
                            msg.type === "user" ? "flex-end" : "flex-start",
                          flexShrink: 0,
                        }}
                      >
                        {/* icon + bubble row (AI: icon left, User: icon right) */}
                        <div
                          style={{
                            display: "flex",
                            alignItems: "flex-end",
                            gap: "8px",
                            flexDirection: "row",
                          }}
                        >
                          {msg.type === "ai" ? (
                            <>
                              {/* AI icon then bubble */}
                              <div
                                style={{
                                  width: 36,
                                  height: 36,
                                  flexShrink: 0,
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                }}
                              >
                                <img
                                  src={aiIconUrl || "/icons/crione.svg"}
                                  alt="ai"
                                  style={{
                                    width: 32,
                                    height: 32,
                                    borderRadius: "50%",
                                  }}
                                />
                              </div>
                              <div
                                style={{
                                  maxWidth: "80%",
                                  padding: "8px 12px",
                                  borderRadius: "12px",
                                  background: "#f1f1f1",
                                  color: "#333",
                                  fontSize: "13px",
                                  wordWrap: "break-word",
                                }}
                              >
                                {msg.content}
                              </div>
                            </>
                          ) : (
                            <>
                              {/* User bubble then icon on the right */}
                              <div
                                style={{
                                  maxWidth: "80%",
                                  padding: "8px 12px",
                                  borderRadius: "12px",
                                  background: "#007bff",
                                  color: "#fff",
                                  fontSize: "13px",
                                  wordWrap: "break-word",
                                }}
                              >
                                {msg.content}
                              </div>
                              <div
                                style={{
                                  width: 36,
                                  height: 36,
                                  flexShrink: 0,
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                }}
                              >
                                {userUploadedImage ? (
                                  <img
                                    src={userUploadedImage}
                                    alt="you"
                                    style={{
                                      width: 32,
                                      height: 32,
                                      borderRadius: "50%",
                                      objectFit: "cover",
                                    }}
                                  />
                                ) : userIcon ? (
                                  (() => {
                                    const key = userIcon;
                                    const size = 32;
                                    const color = "#007bff";
                                    const iconMap: Record<
                                      string,
                                      React.ReactElement
                                    > = {
                                      default: (
                                        <FaRegCircleUser
                                          size={size}
                                          color={color}
                                        />
                                      ),
                                      user: <FaUser size={size} color={color} />,
                                      face: <MdFace size={size} color={color} />,
                                      heart: (
                                        <FaHeart size={size} color={color} />
                                      ),
                                      star: (
                                        <FaStar size={size} color={color} />
                                      ),
                                      coffee: (
                                        <FaCoffee size={size} color={color} />
                                      ),
                                      cat: <FaCat size={size} color={color} />,
                                      dog: <FaDog size={size} color={color} />,
                                      game: (
                                        <FaGamepad size={size} color={color} />
                                      ),
                                      music: (
                                        <FaMusic size={size} color={color} />
                                      ),
                                      palette: (
                                        <FaPalette size={size} color={color} />
                                      ),
                                    };
                                    return iconMap[key] || iconMap.default;
                                  })()
                                ) : (
                                  <div
                                    style={{
                                      width: 32,
                                      height: 32,
                                      borderRadius: "50%",
                                      background: "#ccc",
                                    }}
                                  />
                                )}
                              </div>
                            </>
                          )}
                        </div>

                        {/* timestamp */}
                        <div
                          style={{
                            fontSize: "10px",
                            color: "#888",
                            marginTop: "2px",
                            display: "flex",
                            gap: "6px",
                            alignItems: "center",
                          }}
                        >
                          <span>
                            {msg.timestamp.toLocaleTimeString("ja-JP", {
                              hour: "2-digit",
                              minute: "2-digit",
                            })}
                          </span>
                        </div>
                      </div>
                    ))}

                    {/* „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ */}
                    {isLoading && (
                      <div
                        style={{
                          display: "flex",
                          alignItems: "center",
                          gap: "6px",
                          color: "#666",
                          fontSize: "12px",
                          flexShrink: 0,
                          marginTop: "auto", // Ëá™ÂãïÁöÑ„Å´‰∏ãÈÉ®„Å´ÈÖçÁΩÆ
                        }}
                      >
                        <div
                          style={{
                            display: "flex",
                            gap: "2px",
                          }}
                        >
                          <div
                            style={{
                              width: "4px",
                              height: "4px",
                              background: "#007bff",
                              borderRadius: "50%",
                              animation: "bounce 1.4s infinite",
                            }}
                          ></div>
                          <div
                            style={{
                              width: "4px",
                              height: "4px",
                              background: "#007bff",
                              borderRadius: "50%",
                              animation: "bounce 1.4s infinite 0.2s",
                            }}
                          ></div>
                          <div
                            style={{
                              width: "4px",
                              height: "4px",
                              background: "#007bff",
                              borderRadius: "50%",
                              animation: "bounce 1.4s infinite 0.4s",
                            }}
                          ></div>
                        </div>
                        AI„ÅåËÄÉ„Åà„Å¶„ÅÑ„Åæ„Åô...
                      </div>
                    )}
                  </>
                )}
              </div>
            </div>

            {/* ÂÖ•Âäõ„Ç®„É™„Ç¢ */}
            <div
              style={{
                height: "auto",
                minHeight: "60px",
                display: "flex",
                alignItems: "flex-start",
                padding: "8px",
                marginBottom: 0,
                flexShrink: 0,
              }}
            >
              <div
                style={{
                  display: "flex",
                  gap: "8px",
                  width: "100%",
                  flexDirection: "column",
                }}
              >
                <div
                  style={{ display: "flex", gap: "8px", alignItems: "center" }}
                >
                  <input
                    type="text"
                    placeholder="‰ªä„ÅÆÊ∞óÊåÅ„Å°„ÇÑÂá∫Êù•‰∫ã„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ..."
                    value={message}
                    onChange={(e) => setMessage(e.target.value)}
                    onKeyDown={(e) =>
                      e.key === "Enter" && !isLoading && handleSend()
                    }
                    disabled={isLoading}
                    maxLength={500}
                    style={{
                      flex: 1,
                      height: "40px",
                      padding: "0 12px",
                      border: "1px solid #ccc",
                      borderRadius: "6px",
                      background: isLoading ? "#f5f5f5" : "#fff",
                      fontSize: "14px",
                      color: isLoading ? "#999" : "#333",
                    }}
                  />
                  <button
                    onClick={handleSend}
                    disabled={isLoading || !message.trim()}
                    style={{
                      width: "60px",
                      height: "40px",
                      background:
                        isLoading || !message.trim() ? "#ccc" : "#007bff",
                      color: "#fff",
                      border: "none",
                      borderRadius: "6px",
                      fontSize: "14px",
                      cursor:
                        isLoading || !message.trim() ? "not-allowed" : "pointer",
                    }}
                  >
                    {isLoading ? "..." : "ÈÄÅ‰ø°"}
                  </button>
                </div>

                {/* ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„Çø„Éº */}
                <div
                  style={{
                    textAlign: "right",
                    fontSize: "10px",
                    color: message.length > 450 ? "#c33" : "#999",
                  }}
                >
                  {message.length}/500
                </div>
              </div>
            </div>
          </main>

          <StudentFooter />
        </div>
    </>
  );
}
